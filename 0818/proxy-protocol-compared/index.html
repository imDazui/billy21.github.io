<!DOCTYPE HTML><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="google-site-verification" content="G-FGD5VP876N"><meta name="referrer" content="unsafe-url"><title>加密代理协议简单对比</title><meta name="author" content="Dazui"><meta name="description" content="不乱于心，不困于情。不畏将来，不念过往。如此，安好。"><meta property="og:title" content="加密代理协议简单对比"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="JiangXin.info"><link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed"><link rel="alternate" href="/rss2.xml" title="JiangXin.info" type="application/atom+xml"><link rel="stylesheet" href="/css/m.min.css"><link rel="icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-FGD5VP876N"></script><script data-ad-client="ca-pub-6384335008862617" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-FGD5VP876N")</script><meta name="generator" content="Hexo 6.2.0"></head><body><a id="top"></a><div id="main"><div class="main-ctnr"><div class="behind"><a href="/" class="back black-color"><svg class="i-close" viewBox="0 0 32 32" width="22" height="22" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"><path d="M2 30 L30 2 M30 30 L2 2"></path></svg></a><div class="description">&nbsp;组织结构是生产力。诚然。。。</div></div><article class="standard post"><div class="title"><h1 class="page-title center">加密代理协议简单对比</h1></div><div class="meta center"><time datetime="2018-08-18T11:46:15.000Z" itemprop="datePublished"><svg class="i-calendar" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M2 6 L2 30 30 30 30 6 Z M2 15 L30 15 M7 3 L7 9 M13 3 L13 9 M19 3 L19 9 M25 3 L25 9"></path></svg> &nbsp; 2018-08-18</time><div class="page-tag center" style="display:none"><a href="/tags/HTTPS/">HTTPS</a>·<a href="/tags/SOCKS5-TLS/">SOCKS5-TLS</a>·<a href="/tags/shadowsocks/">shadowsocks</a></div></div><hr><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD"><span class="toc-text">性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-text">数据安全性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%97%E8%AF%86%E5%88%AB"><span class="toc-text">抗识别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E9%9A%BE%E5%BA%A6"><span class="toc-text">部署难度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-text">功能</span></a></li></ol><div class="picture-container"></div><p>目前我们常用的加密代理有协议有 HTTPS，SOCKS5-TLS 和 shadowsocks，此文从各个角度简单分析各个协议的优劣，以帮助各位选择合适的协议。</p><p>先简单说些背景知识，以上协议都是基于 TCP 的代理协议，代理协议（Proxy Procotol）与 VPN 不同，仅可被用于通过代理服务器转发 TCP 连接（shadowsocks 支持代理 UDP），而 VPN 可被用于 IP 层上的所有协议，如 TCP、UDP、ICMP 等。所以在使用代理时，ping 等 ICMP 应用是不可以被代理的。</p><span id="more"></span><p>然后简单解释一下什么是 TLS，TLS 又名 SSL，是针对数据流的安全传输协议。简单来说，一个 TCP 链接，把其中原本要传输的数据，按照 TLS 协议去进行加密传输，那么即可保证其中传输的数据安全。这个安全至少体现在以下几个方面：</p><ol type="1"><li>数据被加密，任何可以截取到 TCP 数据流的人，无法解密出原始数据；</li><li>数据不可被篡改，一旦篡改会导致解密失败，连接断开；</li><li>服务器身份验证，基于 X509 的证书体系去确认目标服务器是否为真实的服务器。</li></ol><p>明文的 HTTP 套上一层 TLS，也就变成了 HTTPS，SOCKS5 套上 TLS，就变成了 SOCKS5-TLS。TLS 协议是整个互联网安全的基石，几乎所有需要安全传输的地方都使用了 TLS，如银行、政府等等。</p><p>当被用作代理协议时，HTTP 层和 SOCKS5 层去进行具体的代理连接控制，如进行身份验证、告知需要转发的目标主机名等。所以不需要 TLS 他们也可以用作代理，只不过所有数据都是明文传输，不具备安全性。加上 TLS 后，由 TLS 去保证安全。而 shadowsocks 协议则融合了代理控制和安全保证。所以后文的很多对比实际上是 shadowsocks 和 TLS 的对比。</p><h2 id="性能">性能</h2><p>TLS 协议由于承担了一项额外的功能，需要验证目标服务器身份，导致其握手时会比较复杂。</p><p>ping 的时间表示，一个 IP 层数据包从本地发出，到服务器再返回的来回时间，即 RTT（round-trip time<strong>）。</strong></p><p>在发起代理连接时，首先我们需要进行 TCP 3 次握手，耗时为 1 个 RTT。（此处把最后的 ACK 直接并入后续的数据传输部分）。</p><p>然后进行 TLS 握手，因为服务端和客户端需要进行身份验证并协商协议版本号、加密方式等细节，第一次连接时需要 <strong>2 个 RTT</strong>。当然 TLS 的制定者也发现这太慢了，于是引入了 TLS Session Resumption，当服务端和客户端服务器连接过一次后，之后的连接可以直接复用先前的协商结果，使得 RTT 降低到 1 个 RTT。但这需要服务器和客户端的支持。（这是为什么 Surge benchmark 时，对于 TLS 代理第一次的测试结果可能较慢的原因之一）</p><p>对于 HTTPS 协议，当 TLS 连接建立后，客户端通过 HTTP 层发起代理请求，服务端回应连接建立，此后进入正常的代理通讯环节，再耗费 1 个 RTT。</p><p>对于 SOCKS5-TLS 协议，当 TLS 连接建立后，如果没有验证的环节，那么需要再耗费 1 个 RTT，如果有验证（用户名密码），那么需要耗费 2 个 RTT。</p><p>而对于 shadowsocks，由于使用的是预共享密钥（pre-shared key, PSK），加密方式也是预先约定好的，所以不需要进行协商，只需要在 TCP 建立之后，再耗费一个 1 个 RTT 告知目标主机名。</p><p>总结如下：</p><ul><li>HTTPS（TLS Session Resumption）：3 个 RTT</li><li>SOCKS5-TLS 无验证：3 个 RTT</li><li>SOCKS5-TLS 有验证：4 个 RTT</li><li>shadowsocks：2 个 RTT</li></ul><p>（注：最后一个 RTT 并不严谨，因为客户端可以在最后一个 RTT 产生响应前，直接开始后续传输。另外如果使用了 TCP Fast Open，可以看作 TCP 阶段 RTT 为 0。）</p><p>对于日常使用，最影响性能的就是握手速度，后续传输过程中的加解密性能，对于现代 CPU 来说基本都不会构成瓶颈。 shadowsocks 由于有 PSK 的特点，在 TCP 协议基础上已经达到极限，不可能有协议能再低于 2 个 RTT。</p><p>所以，同等网络环境下，shadowsocks 是明显快于 HTTPS 的。（体现在延迟上，而不是带宽）</p><p>另外，最新的 TLS 1.3 协议正力图解决这个问题，由于目前还处于草案阶段，各种工具链不完善，现在不太好评估实际效果。</p><h2 id="数据安全性">数据安全性</h2><p>（此处说的数据安全性，指的是加密后的流量是否会被截取并破解的问题。）</p><p>对于 TLS，作为个人用户，丝毫不用担心，TLS 协议如果真的不安全了，世界早就乱套了…</p><p>对于 shadowsocks，使用的加密方法也都是工业上成熟的算法，从数据安全性角度考虑也基本不用担心。</p><h2 id="抗识别">抗识别</h2><p>这个问题有两个角度需要考虑：</p><ol type="1"><li>观察一段数据流量，是否能判别这是一个代理协议的流量；</li><li>对于一个仅暴露出 TCP 端口的黑箱，能否判断这个端口提供了代理服务。</li></ol><p>对于 shadowsocks 协议，在第一点上，观察者只能判定这个数据流为未知的协议。而第二点，shadowsocks 的几次修改，都是因为在这出了问题，目前最新的 AEAD 加密方式，应该已经解决了这个问题，但还需要时间去检验。</p><p>对于 HTTPS 协议，在第一点上，观察者是无法去区分这是一个代理还是一个标准的 HTTPS 网页访问的（当访问 HTTP 页面时，如果访问 HTTPS 会使得流量模型出现特征）。而第二点，在妥善配置的情况下，也是完全无法判别。</p><p>但在实践中，大部分 HTTPS 代理服务器为了兼容浏览器行为，在直接被当做 HTTPS Web 服务器访问时，会返回代理错误页或者 407 Proxy authentication required，直接暴露了自己是一个代理，如果要抗击第二点，可以将服务端的行为修改为，如果请求的 Header 中，不包含一个有效的 Auth，那么就返回一个标准的 200 页面，这样从理论上杜绝了被嗅探的可能。</p><p>总结一下，最新的 shadowsocks 已经能满足抗识别的两个要求，但是观察者得到结论是“未知协议”。而使用 HTTPS，观察者无法判断这是一个 HTTPS 代理还是 HTTPS Web 服务器，这是更优的结果。</p><blockquote><p>Hiding true identities inside a seemingly ordinary. — Person of Interest S03E23</p></blockquote><h2 id="部署难度">部署难度</h2><p>HTTPS 协议使用广泛，有众多成熟的工业级工具，如 squid，haproxy，nghttp2 等等，但是由于 HTTPS 协议本身比较复杂，配置起来参数众多，有很多性能相关参数需要自己调优，所以一般用户配置起来会有难度。</p><p>shadowsocks 经过多年发展，目前也已经有众多的软件支持，但是对于不同特性的支持度不一。由于参数简单，部署配置起来极其方便。</p><h2 id="功能">功能</h2><p>shadowsocks 目前还存在一些功能上的缺陷：</p><ol type="1"><li>shadowsocks 没有设计错误回报机制，对于以下错误，客户端看到的行为都是服务器主动断开 TCP 连接：</li></ol><ul><li>密钥或者加密方法错误</li><li>目标主机名 DNS 解析失败</li><li>目标主机不可达</li><li>目标主机拒绝连接</li></ul><p>这使得客户端没办法根据不同的错误采取进一步的动作，只能简单的向用户返回 Socket closed by remote 错误。</p><ol start="2" type="1"><li>shadowsocks 没有考虑用户鉴别，使得服务端 ACL 或者流量统计等功能无法实现，主流的 workaround 是通过不同的端口号去识别不同的用户，但这极其浪费资源且很不优雅。</li><li>部分 ISP 对于非 HTTP 和 TLS 的未知流量，会进行降速限制，这个可以通过配置 obfs 解决。</li></ol><p>原文：<a href="https://medium.com/@Blankwonder?source=post_header_lockup">Yachen Liu</a>-<a href="https://medium.com/@Blankwonder/%E5%90%84%E7%A7%8D%E5%8A%A0%E5%AF%86%E4%BB%A3%E7%90%86%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%AE%80%E5%8D%95%E5%AF%B9%E6%AF%94-1ed52bf7a803">各种加密代理协议的简单对比</a></p></article><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="busuanzi center">页阅读量:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;・&nbsp; 站访问量:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;・&nbsp; 站访客数:&nbsp;<span id="busuanzi_value_site_uv"></span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
        this.page.url = 'http://jiangxin.info/0818/proxy-protocol-compared/index.html';
        this.page.identifier = ;
        };

        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//jiangxin.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();</script></div></div><footer class="page-footer"><div class="clearfix"></div><div class="right-foot"><div class="firstrow"><a href="#top" target="_self"><svg class="i-caret-right" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"><path d="M10 30 L26 16 10 2 Z"></path></svg> </a>© Dazui 2013-2020</div><div class="secondrow"><a href="https://github.com/gaoryrt/hexo-theme-pln">Theme Pln</a></div></div><div class="clearfix"></div></footer><script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><script src="/js/search.min.js"></script><script type="text/javascript">var disqus_shortname="jiangxin";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}(),$(".dropdown").click((function(e){var n=$(this);e.stopPropagation(),$(n).children(".dropdown-content")[$(n).children(".dropdown-content").hasClass("open")?"removeClass":"addClass"]("open")})),$(document).click((function(){$(".dropdown-content").removeClass("open")}));var path="/search.xml";searchFunc(path,"local-search-input","local-search-result")</script></body></html>