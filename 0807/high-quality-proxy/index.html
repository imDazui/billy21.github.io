<!DOCTYPE HTML><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="google-site-verification" content="G-FGD5VP876N"><meta name="referrer" content="unsafe-url"><title>“工匠精神” 精心打造一个代理服务器</title><meta name="author" content="Dazui"><meta name="description" content="不乱于心，不困于情。不畏将来，不念过往。如此，安好。"><meta property="og:title" content="“工匠精神” 精心打造一个代理服务器"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="JiangXin.info"><link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed"><link rel="alternate" href="/rss2.xml" title="JiangXin.info" type="application/atom+xml"><link rel="stylesheet" href="/css/m.min.css"><link rel="icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-FGD5VP876N"></script><script data-ad-client="ca-pub-6384335008862617" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-FGD5VP876N")</script><meta name="generator" content="Hexo 6.0.0"></head><body><a id="top"></a><div id="main"><div class="main-ctnr"><div class="behind"><a href="/" class="back black-color"><svg class="i-close" viewBox="0 0 32 32" width="22" height="22" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"><path d="M2 30 L30 2 M30 30 L2 2"></path></svg></a><div class="description">&nbsp;组织结构是生产力。诚然。。。</div></div><article class="standard post"><div class="title"><h1 class="page-title center">“工匠精神” 精心打造一个代理服务器</h1></div><div class="meta center"><time datetime="2018-08-07T07:18:36.000Z" itemprop="datePublished"><svg class="i-calendar" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M2 6 L2 30 30 30 30 6 Z M2 15 L30 15 M7 3 L7 9 M13 3 L13 9 M19 3 L19 9 M25 3 L25 9"></path></svg> &nbsp; 2018-08-07</time><div class="page-tag center" style="display:none"></div></div><hr><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%85%A5%E5%8F%A3"><span class="toc-text">代理入口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#shadowsocks"><span class="toc-text">Shadowsocks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-shadowsocks"><span class="toc-text">配置 Shadowsocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shadowsocks-%E4%BC%98%E5%8C%96"><span class="toc-text">Shadowsocks 优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shadowsocks-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">Shadowsocks 配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%BC%E5%AE%B9-web"><span class="toc-text">兼容 WEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sniproxy"><span class="toc-text">SNIPROXY</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%AD%E8%BD%AC%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">中转服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#v2ray"><span class="toc-text">V2ray</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ip-%E5%88%86%E6%B5%81"><span class="toc-text">IP 分流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables"><span class="toc-text">iptables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ipset"><span class="toc-text">ipset</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#udp"><span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-udp"><span class="toc-text">测试 UDP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ipv6-%E6%94%AF%E6%8C%81"><span class="toc-text">IPv6 支持</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%BB%E5%B9%BF%E5%91%8A-%E5%A2%83%E5%A4%96%E5%8F%97%E9%99%90"><span class="toc-text">去广告 &amp; 境外受限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dnsmasq-%E9%85%8D%E7%BD%AE"><span class="toc-text">dnsmasq 配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A7%E5%8A%9F%E5%91%8A%E6%88%90"><span class="toc-text">大功告成～！</span></a></li></ol><div class="picture-container"></div><h1 id="前言">前言</h1><p>首先，本文会涉及众多代理软件的名字，但因为本人是在国外，用代理软件是回国的，是一名爱国青年。所以请大家不要把代理的方向反转来用。</p><p>在国外很多时候打开国内的网站非常缓慢，而且时不时有境外 IP 受限的问题。而代理软件的 obfs 或者 Websocks 能让我冒认成其他软件的服务器干些嘿嘿嘿的事情之外，还能帮助我突破一些的网络限制，比如我们学校的 Wi-Fi ，除了 443 和 80 端口，其他端口很多都是不通的。经过代理后就不会有域名和端口被限制的问题，还能保障安全，随便连各种 Wi-Fi 。</p><p>从而有了这篇文章，整个代理实现了：obfs + 服务器 IP 分流 + UDP 转发 + 去广告 + IPv6 支持 。</p><span id="more"></span><h1 id="代理入口">代理入口</h1><h2 id="shadowsocks">Shadowsocks</h2><p>之所以选择 Shadowsocks 作为代理入口是因为 Shadowsocks 都发展有一段时间了，各平台的客户端也比较完善，用起来比较顺手。而目前 V2ray 的手机客户端目前还不稳定，如果直接用 V2ray 作为入口的话，就可以直接在 V2ray 实现 UDP 转发和 IP 分流，也能用 Caddy 和 Nginx 直接代理它的 Websocks 不需要再套 SNIPROXY，整个过程更加简洁。但截止目前 2017-11-15 ，IOS 端的 ShadowRay 还是很不稳定，丢失 VPN 图标经常发生，而且 IPv6 支持并不完美（不支持直接打开 IPv6 地址），也不支持 UDP 转发。综合以上的考虑，决定使用 Shadowsocks 作为代理的入口。</p><h3 id="配置-shadowsocks">配置 Shadowsocks</h3><p>相信大家对于这个已经不陌生了，我也不过多介绍。</p><blockquote><p>推荐使用 秋水逸冰 的一键安装脚本，Shadowsocks-libev 版 <a href="https://teddysun.com/" class="uri">https://teddysun.com/</a></p></blockquote><h3 id="shadowsocks-优化">Shadowsocks 优化</h3><p>除了基本的安装，当然还要有一些其他的优化，比如打开 BBR 和 TCP Fast Open ，还有一些 sysctl 的优化，我直接放上来。</p><p>原本我是参考小数派里面一篇很好的文章的，里面有详细写到每一项的作用，但 “不知道为什么” ，这文章后来被删除了。</p><p>所以如果大家要了解以下 sysctl 设置的作用的话，可以 Google 一下。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.accept_ra</span> = <span class="number">2</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_fastopen</span> = <span class="number">3</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_congestion_control</span> = bbr</span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.default_qdisc</span> = fq</span><br><span class="line">fs<span class="selector-class">.file-max</span> = <span class="number">1024000</span></span><br><span class="line">kernel<span class="selector-class">.msgmnb</span> = <span class="number">65536</span></span><br><span class="line">kernel<span class="selector-class">.msgmax</span> = <span class="number">65536</span></span><br><span class="line">kernel<span class="selector-class">.shmmax</span> = <span class="number">68719476736</span></span><br><span class="line">kernel<span class="selector-class">.shmall</span> = <span class="number">4294967296</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.rmem_max</span> = <span class="number">12582912</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.wmem_max</span> = <span class="number">12582912</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_rmem</span> = <span class="number">10240</span> <span class="number">87380</span> <span class="number">12582912</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_wmem</span> = <span class="number">10240</span> <span class="number">87380</span> <span class="number">12582912</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syncookies</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_reuse</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_fin_timeout</span> = <span class="number">30</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_keepalive_time</span> = <span class="number">1200</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_mtu_probing</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.accept_source_route</span> = <span class="number">1</span>n</span><br><span class="line">et<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.accept_source_route</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.accept_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.accept_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.lo</span><span class="selector-class">.send_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.rp_filter</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.rp_filter</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.lo</span><span class="selector-class">.rp_filter</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.icmp_echo_ignore_broadcasts</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.icmp_ignore_bogus_error_responses</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.accept_source_route</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.accept_source_route</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.accept_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.accept_redirects</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.autoconf</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv6</span><span class="selector-class">.conf</span><span class="selector-class">.all</span><span class="selector-class">.forwarding</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="shadowsocks-配置文件">Shadowsocks 配置文件</h3><p>因为我们需要兼容到 WEB 服务器的运行，然后用 443 端口来做代理 TCP 和 UDP 的 Shadowsocks 流量。我们要分别跑两个 Shadowsocks 服务，一个是 TCP + obfs server 的，另一个是 UDP Only 的，因为 SNIPROXY 不代理 UDP 流量。</p><p>TCP SERVER:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>:[<span class="string">&quot;[::1]&quot;</span>,<span class="string">&quot;127.0.0.1&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span>:<span class="number">8988</span>,</span><br><span class="line">    <span class="attr">&quot;local_address&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span>:<span class="number">1080</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>:<span class="string">&quot;stevenkwan.me&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span>:<span class="number">600</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>:<span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为服务还需要经过 SNIPROXY 代理，所以监听 IPv4 的 <code>127.0.0.1</code> 即可，顺带提一下 IPv6 里是 <code>[::1]</code> 。</p><p>在运行的时候，还需要加上以下的参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-6 -c /xxxxxx/ss-tls.conf -d 127.0.0.1:53 --plugin obfs-server --plugin-opts &quot;obfs=tls;fast-open&quot;</span><br></pre></td></tr></table></figure><p><code>-6</code> 优先使用 IPv6 地址。</p><p><code>-d</code> 指定 DNS 服务器，这里指定为本机的 dnsmasq 服务器，下面去广告会用到。</p><p>UDP Only SERVER:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>:[<span class="string">&quot;[::0]&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span>:<span class="number">443</span>,</span><br><span class="line">    <span class="attr">&quot;local_address&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span>:<span class="number">443</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>:<span class="string">&quot;stevenkwan.me&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span>:<span class="number">600</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>:<span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 UDP 是需要直接暴露在公网的 443 端口。</p><p>在运行的时候，还需要加上以下的参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-6 -U -c /xxxx/udp-443.conf -d 127.0.0.1:53</span><br></pre></td></tr></table></figure><p><code>-U</code> 大写的 U 代表只开启 UDP 转发不开启 TCP 转发，如果写成小写的话，是两个同时开始。有 WEB Server 的话就会提示端口已经被占用。</p><h1 id="兼容-web">兼容 WEB</h1><h2 id="sniproxy">SNIPROXY</h2><p>SNIPROXY 的设置非常简单，直接上配置文件。</p><p>需要注意的是，启用前，要先将 WEB Server 改成非 443 端口。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">user daemon</span><br><span class="line"></span><br><span class="line">pidfile /tmp/sniproxy<span class="selector-class">.pid</span></span><br><span class="line"></span><br><span class="line">error_log &#123;</span><br><span class="line">    syslog daemon</span><br><span class="line">    priority notice</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">listen <span class="number">443</span> &#123;</span><br><span class="line">    protocol tls</span><br><span class="line">    reuseport no</span><br><span class="line">    <span class="selector-tag">table</span> https</span><br><span class="line">    fallback <span class="selector-attr">[::1]</span>:<span class="number">445</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">table</span> https &#123;</span><br><span class="line">    www<span class="selector-class">.google</span><span class="selector-class">.com</span> <span class="selector-attr">[::1]</span>:<span class="number">8988</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>fallback</code> 指向你的 WEB Server 端口即可。</p><p><code>table https</code> 里面写你 Shadowsoks 里使用的 obfs 域名。</p><h1 id="中转服务器">中转服务器</h1><h2 id="v2ray">V2ray</h2><p>除了我上面说的 V2ray 客户端不足，V2ray 还是有很多优势的，适合用来 “长距离” “翻山越岭” 。它支持 mkcp 和 mux 。</p><p>我曾经用过 Shadowsocks 作为中转服务器，那速度真的太慢了。</p><p>这里我用到了 mkcp 和 动态端口。</p><p>国内服务器配置文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;inbound&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;port&quot;</span>: <span class="number">8888</span>,</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;kcp&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;clients&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;xxxxxxxxxx&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;level&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;alterId&quot;</span>: <span class="number">32</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;detour&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;detour-kcp&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;inboundDetour&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;port&quot;</span>: <span class="string">&quot;8889-9999&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;tag&quot;</span>: <span class="string">&quot;detour-kcp&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">&quot;allocate&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;strategy&quot;</span>: <span class="string">&quot;random&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;concurrency&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span>: <span class="number">5</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;kcp&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;outbound&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;outboundDetour&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">&quot;tag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;rules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;ip&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;0.0.0.0/8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;10.0.0.0/8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;100.64.0.0/10&quot;</span>,</span><br><span class="line">            <span class="string">&quot;127.0.0.0/8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;169.254.0.0/16&quot;</span>,</span><br><span class="line">            <span class="string">&quot;172.16.0.0/12&quot;</span>,</span><br><span class="line">            <span class="string">&quot;192.0.0.0/24&quot;</span>,</span><br><span class="line">            <span class="string">&quot;192.0.2.0/24&quot;</span>,</span><br><span class="line">            <span class="string">&quot;192.168.0.0/16&quot;</span>,</span><br><span class="line">            <span class="string">&quot;198.18.0.0/15&quot;</span>,</span><br><span class="line">            <span class="string">&quot;198.51.100.0/24&quot;</span>,</span><br><span class="line">            <span class="string">&quot;203.0.113.0/24&quot;</span>,</span><br><span class="line">            <span class="string">&quot;::1/128&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fc00::/7&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fe80::/10&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;transport&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;kcpSettings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;mtu&quot;</span>: <span class="number">1400</span>,</span><br><span class="line">      <span class="attr">&quot;tti&quot;</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">&quot;uplinkCapacity&quot;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;downlinkCapacity&quot;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;congestion&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;readBufferSize&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;writeBufferSize&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;header&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;none&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请自行修改配置文件的端口、动态端口范围、客户 ID 。</p><p>国外服务器配置文件：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;inbound&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;dokodemo-door&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;port&quot;</span>: <span class="number">1080</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;tcp,udp&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;timeout&quot;</span>: <span class="number">30</span>,</span><br><span class="line">      <span class="attr">&quot;followRedirect&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;outbound&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;network&quot;</span>: <span class="string">&quot;kcp&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mux&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;concurrency&quot;</span>: <span class="number">8</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;vnext&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;port&quot;</span>: <span class="number">8888</span>,</span><br><span class="line">          <span class="attr">&quot;users&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;xxxxxxxxxx&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;alterId&quot;</span>: <span class="number">32</span>,</span><br><span class="line">              <span class="attr">&quot;security&quot;</span>: <span class="string">&quot;aes-128-gcm&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;transport&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;kcpSettings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;mtu&quot;</span>: <span class="number">1400</span>,</span><br><span class="line">      <span class="attr">&quot;tti&quot;</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">&quot;uplinkCapacity&quot;</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">&quot;downlinkCapacity&quot;</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">&quot;congestion&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;readBufferSize&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;writeBufferSize&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;header&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;none&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们将 V2ray 的 inbound 设置为透明代理，这样 iptables 就能把国内流量转发到 V2ray 上。</p><blockquote><p>更详细的设置 V2ray 设置可以参考他们家的官网 <a href="https://www.v2ray.com/">https://www.v2ray.com</a></p></blockquote><h1 id="ip-分流">IP 分流</h1><h2 id="iptables">iptables</h2><p>要根据 IP 来分流，除了 iptables 之外，也没其他什么软件能做到了。但是单纯靠 iptables 来分流的话，会造成性能低下，这时候我们需要 ipset 。</p><p>下面这篇文章测试了在使用 ipset 和不使用 ipset 时 iptables 的性能。</p><blockquote><p><a href="http://blog.csdn.net/dog250/article/details/41171643" class="uri">http://blog.csdn.net/dog250/article/details/41171643</a></p></blockquote><h3 id="ipset">ipset</h3><p>在这里推荐大家用这个项目来获取中国的 IP 地址，每月更新的。</p><blockquote><p><a href="https://github.com/17mon/china_ip_list" class="uri">https://github.com/17mon/china_ip_list</a></p></blockquote><p>这里我只转发了 TCP 流量：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipset -N chnroute hash:net maxelem <span class="number">65536</span></span><br><span class="line">ipset add chnroute <span class="variable">$IP</span></span><br><span class="line">iptables -t nat -N V2RAY</span><br><span class="line">iptables -t nat -A V2RAY -<span class="selector-tag">p</span> tcp -m set --match-set chnroute dst -j REDIRECT --to-port <span class="number">1080</span></span><br><span class="line">iptables -t nat -A OUTPUT -<span class="selector-tag">p</span> tcp -j V2RAY</span><br></pre></td></tr></table></figure><p>将上面的 <code>$IP</code> 换成你需要添加的 IP 地址，推荐大家用脚本来添加，这样可以设置成每月任务，自动更新。</p><p>更新前，通常需要先移除旧规则：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -D OUTPUT -<span class="selector-tag">p</span> tcp -j V2RAY</span><br><span class="line">iptables -t nat -F V2RAY</span><br><span class="line">iptables -t nat -X V2RAY</span><br><span class="line">ipset destroy chnroute</span><br></pre></td></tr></table></figure><h1 id="udp">UDP</h1><p>在上面配置 Shadowsocks 服务端的时候，我们已经做好了完整的 UDP 转发支持。但客户端支不支持，却又是另一回事，我们可以通过以下方法来测试。</p><h2 id="测试-udp">测试 UDP</h2><p>我们在服务器上打开一个 screen 运行 <code>nc -lu 20000</code> 来监听 20000 端口的 UDP 。</p><p>然后在需要测试的设备上，发一个 UDP 包到你的服务器上。</p><p>如果服务器能收到这个 UDP 包，那么就可以再新开一个 screen 运行 <code>netstat -nu | grep 20000</code> 来查看来源 IP ，通过来源 IP 来判断是否走了代理。</p><p>截止 2017-11-15 ，IOS 客户端就只有 Shadowrocket 支持 UDP 转发，Surge 和 ShadowRay 均为直连。</p><h1 id="ipv6-支持">IPv6 支持</h1><p>在上面配置 Shadowsocks 服务端的时候，已经做好了完整的 IPv6 支持，大家可以打开一下网站里面的 “技术信息” 来测试 IPv6 。</p><blockquote><p><a href="http://test-ipv6.com/">http://test-ipv6.com</a></p></blockquote><p>截止 2017-11-15 ，IOS 客户端就只有 Surge 支持直接打开 IPv6 地址，Shadowrocket 和 ShadowRay 均失败。</p><h1 id="去广告-境外受限">去广告 &amp; 境外受限</h1><p>自建 DNS 服务器除了能达到去广告的目的外，还能解决部分国内服务商将域名在国外解析成 <code>127.0.0.1</code> 的问题（如网易云音乐）。</p><p>关于如何更好的解除境外受限，大家可以参考一下以下项目。</p><blockquote><p><a href="https://github.com/uku/Unblock-Youku" class="uri">https://github.com/uku/Unblock-Youku</a></p></blockquote><p>DNS 去广告的效果也是非常好的，因为是从根源上返回一个 fake IP ，无论是 HTTP 和 HTTPS 都支持。</p><p>但域名列表是需要经常更新的，大家可以写个脚本来定期更新。</p><p>这里推荐一下这个更新广告域名的项目：</p><blockquote><p><a href="https://github.com/StevenBlack/hosts" class="uri">https://github.com/StevenBlack/hosts</a></p></blockquote><p>还有个小问题是，大多数的去广告 hosts 文件都是把 IP 指向了 <code>127.0.0.1</code> 或者 <code>0.0.0.0</code> ，但我服务器上是有 WEB Server 的，这会造成浏览器在尝试连接时，会等待结果而不是立即断开连接。我也试过把 IP 地址改成美国国防部的保留 IP 地址，然后通过 iptables 把所有出去的包 drop 了，效果也是不理想。推荐大家把 IP 指向 <code>224.0.0.0</code> 等特殊 IP 地址，实测不会拖慢网页加载速度。（以上结论暂时还没有进行过详细的测试，仅凭实测，如有错误，欢迎指出）</p><h2 id="dnsmasq-配置">dnsmasq 配置</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">port=<span class="number">53</span></span><br><span class="line">no-resolv</span><br><span class="line">server=<span class="number">2001</span>:<span class="number">4860</span>:<span class="number">4860</span>::<span class="number">8888</span></span><br><span class="line">server=<span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line">server=<span class="number">2620</span>:<span class="number">0</span>:ccc::<span class="number">2</span></span><br><span class="line">server=<span class="number">208.67</span>.<span class="number">222.222</span></span><br><span class="line">all-servers</span><br><span class="line">listen-address=<span class="number">127.0</span>.<span class="number">0.1</span>,::<span class="number">1</span></span><br><span class="line">addn-hosts=/etc/dnsmasq_host/hosts</span><br></pre></td></tr></table></figure><p>这里我设置了 4 个 DNS 上有地址，是 Google Public DNS 和 OpenDNS 的 IPv4 和 IPv6 地址，用了 <code>all-servers</code> 选项去并发查询这 4 个服务器，取最先返回结果的。</p><p>如果 Shadowsocks 开启了 IPv6 优先的话，hosts 文件也要加入 IPv6 的地址，推荐使用 'FF00::' 。</p><p>因为 DNS 服务器只是给本机使用的，安全起见可以只监听 <code>127.0.0.1</code> 。</p><p><code>addn-hosts</code> 则为去广告所用的 hosts 文件。</p><h1 id="大功告成">大功告成～！</h1><p>至此为此，安全性和各种功能都有了，可以无拘无束的安心上网了。</p><p>原文链接：<a href="https://stevenkwan.me/post/perfect-proxy-server.html" class="uri">https://stevenkwan.me/post/perfect-proxy-server.html</a></p><p>-- EOF --</p></article><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="busuanzi center">页阅读量:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;・&nbsp; 站访问量:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;・&nbsp; 站访客数:&nbsp;<span id="busuanzi_value_site_uv"></span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
        this.page.url = 'http://jiangxin.info/0807/high-quality-proxy/index.html';
        this.page.identifier = ;
        };

        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//jiangxin.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();</script></div></div><footer class="page-footer"><div class="clearfix"></div><div class="right-foot"><div class="firstrow"><a href="#top" target="_self"><svg class="i-caret-right" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"><path d="M10 30 L26 16 10 2 Z"></path></svg> </a>© Dazui 2013-2020</div><div class="secondrow"><a href="https://github.com/gaoryrt/hexo-theme-pln">Theme Pln</a></div></div><div class="clearfix"></div></footer><script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><script src="/js/search.min.js"></script><script type="text/javascript">var disqus_shortname="jiangxin";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}(),$(".dropdown").click((function(e){var n=$(this);e.stopPropagation(),$(n).children(".dropdown-content")[$(n).children(".dropdown-content").hasClass("open")?"removeClass":"addClass"]("open")})),$(document).click((function(){$(".dropdown-content").removeClass("open")}));var path="/search.xml";searchFunc(path,"local-search-input","local-search-result")</script></body></html>